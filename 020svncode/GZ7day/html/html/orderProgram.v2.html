<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>无标题文档</title>
<link href="../css/pub.css" rel="stylesheet" type="text/css" />

<script src="../js/keyDefine.js"></script>
<script src="../js/config.js"></script>
<script src="../js/global2.0.js"></script> 
<script src="../js/GKey.js"></script> 
<script src="../js/JAlex.js"></script>
<script src="../js/ajax_1.0.js"></script>
<script src="../js/DataCollection.js"></script>
<script>
	//SET ADD
	
	ADD_MO = "order";
	ADD_MONAME = "自助服务|频道预订"
	ADD_LE = 31;
	ADD_PA = "orderPorgram";
	ADD_NAME = "预订管理";
	ADD_OT = SysSetting.getEnv("PORTAL_ADDR");
	
</script>

</head>
<body>

<div class="systel_bg" style="background:url(../images/order_manager.jpg)">
	<div class="tip_box_bg">
    	<div class="tip_box_title">是否取消预订节目</div>
<!--    	<div class="tip_box_button_01"><img src="../images/ok.png" width="190" height="60" /></div>
    	<div class="tip_box_button_02"><img src="../images/cancel.png" width="190" height="60" /></div>
-->    	<div class="tip_box_button_03"><img src="../images/cancel.png" width="190" height="60" /></div>
    </div>

  <div class="system_time">
    <div  class="weather"></div>
    <div id="time_HMS"></div><div id="time_YMDW"></div>
  </div>
  <div class="system_menu_text_box" id="page_title"> 频道预订管理(0/0) </div>
  <div class="system_con_focus"></div>
	<div class="system_con_focus_02" id="focus_list"></div>
  <div class="system_con_box">
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="system_menu_table system_table_l_pad">
      <tr class="pages_title">
        <td width="31%">节目时间</td>
        <td width="30%">频道</td>
        <td width="31%">节目列表</td>
        <td width="8%">状态</td>
      </tr>
      <tr  class="list_font font32" id="list0">
        <td width="31%" id="startTime_0">&nbsp;</td>
        <td width="30%" id="chan_name_0">&nbsp;</td>
        <td width="31%" id="eventName_0">&nbsp;</td>
        <td width="8%" id="delete_0">&nbsp;</td>
      </tr>
      <tr  class="list_font" id="list1">
        <td width="31%" id="startTime_1">&nbsp;</td>
        <td width="30%" id="chan_name_1">&nbsp;</td>
        <td width="31%" id="eventName_1">&nbsp;</td>
        <td width="8%"  id="delete_1">&nbsp;</td>
      </tr>
      <tr  class="list_font" id="list2">
        <td width="31%" id="startTime_2">&nbsp;</td>
        <td width="30%" id="chan_name_2">&nbsp;</td>
        <td width="31%" id="eventName_2">&nbsp;</td>
        <td width="8%"  id="delete_2">&nbsp;</td>
      </tr>
      <tr  class="list_font" id="list3">
        <td width="31%" id="startTime_3">&nbsp;</td>
        <td width="30%" id="chan_name_3">&nbsp;</td>
        <td width="31%" id="eventName_3">&nbsp;</td>
        <td width="8%"  id="delete_3">&nbsp;</td>
      </tr>
      <tr  class="list_font" id="list4">
        <td width="31%" id="startTime_4">&nbsp;</td>
        <td width="30%" id="chan_name_4">&nbsp;</td>
        <td width="31%" id="eventName_4">&nbsp;</td>
        <td width="8%"  id="delete_4">&nbsp;</td>
      </tr>
    </table>
  </div>
  <div class="tip_03_div" id="tip_03_div">
    <div class="tip_box_bg_03"></div>
    <div class="tip_box_03_tp">
      <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tip_box_03_table">
        <tr>          
          <td width="63"><span class="tip_box_03_l" id="selectTag_0"><img src="../images/returns_icon2.png" width="50" height="59" /></span></td>
          <td width="269"><span class="tip_box_03_r">删除选中预定</span></td>
        </tr>
        <tr>
          <td width="63"><span class="tip_box_03_l" id="selectTag_0"><img src="../images/returns_icon3.png" width="50" height="59" /></span></td>
          <td width="269"><span class="tip_box_03_r">删除所有预定</span></td>
        </tr> 
        <tr>
          <td width="63"><span class="tip_box_03_l"  id="selectTag_2"><img src="../images/returns_icon.png" width="50" height="59" /></span></td>
          <td width="250"><span class="tip_box_03_r" >取消</span></td>
        </tr>      
      </table>
    </div>
    <div class="tip_box_focus_03" id="tip_box_focus_03"></div>
  </div>
  <div class="tip_02">
    <table width="1085" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td width="171"><table width="166" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td width="137"><img src="../images/tip_returns.png" width="137" height="23" /></td>
          </tr>
        </table></td>
        <td width="219"><table width="212" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td width="175"><img src="../images/del_all_order.png" width="175" height="23" /></td>
          </tr>
        </table></td>
        <td width="169"><table width="166" border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td width="130"><img src="../images/del_order.png" width="130" height="23" /></td>
          </tr>
        </table></td>        
        <td width="118">&nbsp;</td>
        <td width="239">&nbsp;</td>
      </tr>
    </table>
  </div>
</div>

<script>
PRINT_PREFIX = "[orderMgr]";
function backToMain(){
    window.location.href = "orderManager.v2.html";
}
global_control_mode = 1;
  
try{
var page = new JPage();
page.grabEvent.pageEvent = function pageEvent(event){
	var val = event.which|event.keycode;
	switch(val){
		case ROC_IRKEY_DOWN: 
		break;
		case ROC_IRKEY_SELECT:
		     if(pageObj.CAInfoList.isEvenSelect){
				 pageObj.CAInfoList.isEvenSelect = false;
			     pageObj.tipDivControl.showTag = true;
			     pageObj.tipDivControl.init();
			 }
		break; 
	}
	return true;
}
}catch(e){}

function grabEvent(event){	
	return page.grabEvent.Listener(event);
}

function page_systemevent_handler(event){
	page.grabEvent.Listener(event);
	return true;
}

function pageObj(){
	 
	this.CAInfoList = new CAInfoList();  //纵向
	function CAInfoList(){
		this.index = 0;   
		this.pageSize = 5;//横向总栏目数
		this.top = 288;
		this.height = 66;	 
		this.items = new Array();  
		this.page = 0;
		this.maxPage = 0;
		this.isEvenSelect = false;
		this.showTag = true;
		
		this.init = function(items){ 
			if(items == null || items.length <= 0)
				return;			
			this.items = items; 
			this.index = 0;
			this.maxPage = Math.ceil(this.items.length / this.pageSize) - 1;
			this.page = Math.ceil((this.index + 1)/this.pageSize) - 1;    
			this.showData();
			this.focusOff(0);
			this.focusOn(this.index);   
		} 
		this.getStep = function(idx){  
			return this.top + this.height * (idx % this.pageSize); 
		} 
		this.showData = function(){
			this.initResetPage(); 
			for(var i=0;i<Math.min(this.pageSize,this.items.length-this.pageSize*this.page);i++){
				var idx = this.pageSize * this.page;  
				if(this.getOrderService(this.items[idx+i]).ServiceName.length>8){
					$("chan_name_"+i).innerHTML = 
						(this.getOrderService(this.items[idx+i]).ServiceName).substring(0,7)+"...";
				}  
				else
					$("chan_name_"+i).innerHTML = this.getOrderService(this.items[idx+i]).ServiceName;
               $("startTime_"+i).innerHTML = this.items[idx+i].whichEvent.date+" "+this.items[idx+i].whichEvent.startTime;
				$("eventName_"+i).innerHTML = (this.items[idx+i].whichEvent.name).length<=9?(this.items[idx+i].whichEvent.name):(this.items[idx+i].whichEvent.name).substring(0,8)+"...";
                this.showProp(idx+i, "delete"); 
			}
			if (this.maxPage != 0) {
				$("page_title").innerHTML = "频道预定管理("+ (this.page + 1) +"/"+ (this.maxPage + 1)+")";
			} else {
				$("page_title").innerHTML = "频道预定管理(0/0)";
			}
		}
		this.initResetPage = function(){
			 for(var i=0;i< this.pageSize;i++){
				  this.focusOff(i); 
				   $("chan_name_"+i).innerHTML = "";
				   $("startTime_"+i).innerHTML = "";
				   $("eventName_"+i).innerHTML = "";
                   $("delete_"+i).innerHTML = "";
			  }
		}
		this.getCurrentItem = function(){
			if(this.items.length==0) return null;
			return this.items[this.index];
		}
		this.showProp = function(idx, prop){ 
			var pageIdx = idx % this.pageSize;
			switch(prop){
				case "delete":
					if(this.items[idx].deleteFlag==1){
						$("delete_"+pageIdx).innerHTML="<img src='../images/del_02.png' width='38' height='34' />";  
					}else{
						$("delete_"+pageIdx).innerHTML="<img src='../images/order.png' width='38' height='34' />";
					}
					break;
				default:
					break;
			}
		}
		this.focusOff = function(i){
			$("list"+i).className = "list_font "; 
			if((this.items[this.index].whichEvent.name).length>9){
				$("eventName_"+i).innerHTML = (this.items[this.index].whichEvent.name).substring(0,8)+"...";
			}
			if(this.getOrderService(this.items[this.index]).ServiceName.length>8){
				$("chan_name_"+i).innerHTML = (this.getOrderService(this.items[this.index]).ServiceName).substring(0,7)+"...";
			}
		}
		this.focusOn = function(i){
			$("focus_list").style.top=this.getStep(i)+"px";
			var idx = i % this.pageSize;
			$("list"+idx).className = "list_font font32"; 
			if((this.items[i].whichEvent.name).length>9){
				$("eventName_"+idx).innerHTML = "<marquee>"+this.items[i].whichEvent.name+"</marquee>"
			}
			if(this.getOrderService(this.items[i]).ServiceName.length>8){
				$("chan_name_"+i).innerHTML = "<marquee>"+this.getOrderService(this.items[i]).ServiceName+"</marquee>";
			}
		} 
		this.pageUp = function(){
			if(this.items == null || this.items.length <= 0)
				return;
			this.focusOff(this.index % this.pageSize);
			this.page = this.page == 0 ? this.maxPage : --this.page;
			this.index = this.page * this.pageSize;
			this.showData();
			this.focusOn(this.index); 
		}
		this.pageDown = function(){
			if(this.items == null || this.items.length <= 0)
				return;
			this.focusOff(this.index % this.pageSize);
			this.page = this.page == this.maxPage ? 0 : ++this.page;
			this.index = this.page * this.pageSize;
			this.showData();
			this.focusOn(this.index); 
		}
		this.up = function(){
			if(this.items == null || this.items.length <= 0 ) return;
			this.focusOff(this.index % this.pageSize);
			var oldpage = Math.ceil((this.index + 1)/this.pageSize) - 1;
			this.index = this.index == 0 ? this.items.length - 1: this.index -1;
			this.page = Math.ceil((this.index + 1)/this.pageSize) - 1;
			if(oldpage!=this.page){
				this.showData();
			}
			this.focusOn(this.index);  
		}
		this.down = function(){ 
			if(this.items == null || this.items.length <= 0 ) return;
			this.focusOff(this.index % this.pageSize);
			var oldpage = Math.ceil((this.index + 1)/this.pageSize) - 1;
			this.index = this.index == this.items.length - 1 ? 0 : this.index + 1;
			this.page = Math.ceil((this.index + 1)/this.pageSize) - 1;  
			if(oldpage != this.page){
				this.showData();
			}
			this.focusOn(this.index);  
		}
		 
		this.ORDER_PROP_deleteFlag = 0; 
		this.setOrderProp = function(OrderObj, propType, propValue){
			switch(propType){
				case ORDER_PROP_deleteFlag:
					OrderObj.deleteFlag = propValue; 
					break;
				default:
					break;
			}
		} 
		this.getOrderProp = function(OrderObj, propType){
			var retValue = null;
			switch(propType){
				case ORDER_PROP_deleteFlag:
					retValue = OrderObj.deleteFlag;
					break;
				default:
					break;
			}
			return retValue;
		} 
		this.saveOptions = function (){
			user.orders.deleteAll(129);//将所有标记为删除的频道确实删除掉
			user.orders.save(); //TODO: 1.21的规范中,此接口无返回值.对此有疑虑!!
			return 1;
		} 
		this.restoreOptions = function(){
			return user.orders.restore();
		} 
		this.getOrderService = function(orderObj){
			var e = orderObj.whichEvent;
			return getSIConfigService(e.NetworkID, e.TSID, e.serviceID); 
		}
		this.yellow = function(){ 
			var item = this.getCurrentItem();
			if(this.getOrderProp(item, this.ORDER_PROP_deleteFlag)==0){
					this.setOrderProp(item, this.ORDER_PROP_deleteFlag, 1);
					this.showProp(this.index, "delete");
			}
		}
		this.green = function(){ 
			var item = this.getCurrentItem();
			if(this.getOrderProp(item, this.ORDER_PROP_deleteFlag)==1){
					this.setOrderProp(item, this.ORDER_PROP_deleteFlag, 0);
					this.showProp(this.index, "delete");
			}
		}
		this.red = function(){  			  
			 user.orders.deleteAll();//将所有标记为删除的频道确实删除掉
			 user.orders.save(); //TODO: 1.21的规范中,此接口无返回值.对此有疑虑!!
			 location.href = "orderProgram.v2.html";
		}
		this.select = function(){
			if(this.items.length ==0 ){
				this.isEvenSelect = false;
			}else{
				this.showTag = false;
			    this.isEvenSelect = true;
			}			
		}
		this.Listener = function(event){ 
			var val = event.which | event.keyCode;
			if(this.showTag){ 
				switch(val){
					case ROC_IRKEY_DOWN:
						this.down();
						return false;
					break;
					case ROC_IRKEY_UP: 
						this.up();
						return false;
					break;
					case ROC_IRKEY_PAGE_DOWN: 
						this.pageDown();
						return false;
					break;
					case ROC_IRKEY_PAGE_UP: 
						this.pageUp();
						return false;
					break;
					case ROC_IRKEY_SELECT:
						this.select();
						return true;
					break;   
					case ROC_IRKEY_YELLOW:
						if(this.items.length ==0 )
							return;
						globalAlert.init({
							 "val":"确定删除该节目",
							 "btnInfo":
							 [
								 {"name":"确定","callBack":function(){pageObj.tipDivControl.chl_delete();}},
								 {"name":"取消","callBack":null}
							 ],
							 "timeout":0
						 });						
						return false;
					break;					
					case ROC_IRKEY_RED:
						if(this.items.length ==0 )
							return;
						 globalAlert.init({
							 "val":"确定删除所有预定节目",
							 "btnInfo":
							 [
								 {"name":"确定","callBack":function(){pageObj.tipDivControl.chl_deleteAll();}},
								 {"name":"取消","callBack":null}
							 ],
							 "timeout":0
						 });
						 return false;
					break;
				}
			}
			return true;
		} 
	} 
	this.tipDivControl = new tipDivControl(this); 
	function tipDivControl(){   //属性设置框
		this.showTag = false;  
		this.focusBarTop = 30;
		this.focusbarHeight = 59;
		this.pageSize = 2;
		this.index = 0;
		
		this.init = function(){
		    this.index = 0; 
			this.showData(true);
		} 
		this.showData = function(isDisplay){ 
			 if(isDisplay){ 
				  this.show();  
				  this.focusOn();
			 }else{
				  this.hide();   
			 }   
		} 
		this.show = function(){
			$("tip_03_div").style.display = "block";
		}
		this.hide = function(){
			$("tip_03_div").style.display = "none";
		} 
		this.focusOn = function(focusTop){
			var focusTop = this.focusBarTop + this.index * this.focusbarHeight
			$("tip_box_focus_03").style.top = focusTop+"px";
		}
		this.up = function(){
			if(this.index == 0){
				this.index = 2;
			}else{
				this.index --;
			}
			this.focusOn();
		}
		this.down = function(){
			if( this.index == 2){
				this.index =0;
			}else{
				this.index ++;
			}
			this.focusOn();
		}
		this.back = function(){
			this.showTag = false;
			this.hide();
			pageObj.CAInfoList.showTag = true;  
		}
		this.chl_delete = function (){
		    var item = pageObj.CAInfoList.getCurrentItem();
		    user.orders.del(item);
		    user.orders.save();
		    location.href = "orderProgram.v2.html";				
		}
		this.chl_deleteAll = function (){
			user.orders.deleteAll();//将所有标记为删除的频道确实删除掉
			user.orders.save(); //TODO: 1.21的规范中,此接口无返回值.对此有疑虑!!
			location.href = "orderProgram.v2.html";
		}
		this.select = function(){
			switch(this.index){				   
			   case 0:
				  this.chl_delete();//删除预定
			   break;
			   case 1:
				  this.chl_deleteAll();//删除所有预定
			   break;
			   case 2:
				  this.back(); 
			   break;
			} 
			this.showTag = false;
			this.hide();		 
		} 
		this.Listener = function(event){
			var val = event.which | event.keyCode;
			if(this.showTag){
				switch(val){    
					case ROC_IRKEY_UP: 
						this.up();
						return false;
					break;
					case ROC_IRKEY_DOWN:  
						this.down();
						return false;
					break; 
					case ROC_IRKEY_SELECT:
						this.select();
						return false;
					break;
					case ROC_IRKEY_RED://删除所有预定
                        this.chl_deleteAll();
                    break;           
                    case ROC_IRKEY_YELLOW://删除预定
            	        this.chl_delete();
                    break;
					case ROC_IRKEY_EXIT: 						 
					case ROC_IRKEY_BACK: 
						 this.back(); 
						  return false;
					break;
				}
			}
			return true;
		}
	}	 
	 
	this.init = function(){   
		var info = user.getOrders(0);
		var orderList = [];
		for (var i = 0; i < info.length; i++) {
		 	var evt = info[i].whichEvent;
			var now = util.date.format(new Date(), "yyyy-MM-dd hh:mm:ss");
			var evtStartTime = evt.date + " " + evt.startTime;
			console.debug("=======================now:" + now);
			console.debug("=======================evtStartTime:" + evtStartTime);
			console.debug("=======================evtStartTime < now:" + (evtStartTime < now));
			if (evtStartTime < now) {
				user.orders.del(info[i]);	
			} else if (pageObj.CAInfoList.getOrderService(info[i])){
				orderList.push(info[i]);	
			}
		}
		user.orders.save();
		this.CAInfoList.init(orderList);	   
		showDateTime(); 
	} 
} 

//try{
	//注册页面
	var pageObj = new pageObj();  
	page.regedit(pageObj.CAInfoList);
	page.regedit(pageObj.tipDivControl);
//}catch(e){alert(e.message)}	

function initPage(){ 
		pageObj.init(); 
		DataCollection.collectData(["01","main://html/html/orderProgram.v2.html"+window.location.search,SysSetting.getEnv("SOURCE_PATH"),"预订管理"]);
		SysSetting.setEnv("SOURCE_PATH","main://html/html/orderProgram.v2.html"+window.location.search);
}
function exitPage(){
  user.orders.save();
}

window.onload = initPage;
window.onunload = exitPage;
</script>

<script src="../js/ADD_C.js"></script>


</body>
</html>
