##  开机广告

```
需要欢网提供服务端获取广告接口文档

广告系统支持单引擎，同时也要支持双引擎的盒子

只在机顶盒开机后进入launcher页面前才会播放开机广告，其他按菜单刷新不会触发广告


（5）OMS后台支持下发参数：开机广告是否开启设置、位置广告是否开启设置、客户端广告最少观看时长设置，开机请求广告系统超时时间设置。 终端（静态页面，双引擎APK）通过拿到参数后进行相应处理逻辑。
（6）机顶盒开机后请求广告系统并播放广告，异常情况处理原则：请求广告系统超时（包括网络不通的情况），超时参数由后台iepg进行下发，出现超时后，终端直接进入launcher页面加载流程。

用户观看广告系统数据的行为统计只上报给同洲大数据平台
```

### js

```js
// 初始化系统参数：（ADS）
var ShutdownStartupAd = false // 一键关停开机广告：OFF  开机广告，向监测系统上报
var ShutdownPositionAd = false//一键关停位置广告：OFF   位置广告，向大数据上报。
var PressKeyToExitTime = 5//可按键退出时长参数：5
var AdvertisingTimeoutPeriod = 5//广告超时时长：5

// 返回键退出广告 后台可设是否可以退出和可退出时长
// 向IEPG后台请求开机广告系统参数 请求平台iepg getPram接口，获取开机广告开关、最少观看时长、广告超时时长

function('请求是否超时（3S)？'){
  if('请求是否超时（3S)？' = false){
    '更新开机广告系统参数'
  }
  function('一键关停开机广告是否为ON？')
}

function('一键关停开机广告是否为ON？'){
  if('一键关停开机广告是否为ON？'){
    function('请求融合AAA （一镇一屏)')
  }else{
    '进入launcher主页'
  }
}

function('请求融合AAA （一镇一屏)'){
  // 获取区域码，未命中，则继续请求用户信息查询接口，获取区域码
  if('district_Code获取成功？' = false){
    '请求用户信息查询接口获取district_code'
    if('district_Code获取成功？' = false){
      '使用默认的0000区域码'
    }
  }
  function('获取机顶盒号SN')
}

function('获取机顶盒号SN'){
  if('机顶盒序列号SN获取成功？'){
    '将该值作为作为参数保存'
  }else{
    '使用默认机顶盒号作为参数保存    15个0'
  }

  function('请求广告系统api获取广告物料、是否显示“广告”字样曝光url等数据')
  function('请求广告视频（CDN）是否超时？ 2s')

}
/*  */
function('请求广告系统api获取广告物料、是否显示“广告”字样曝光url等数据'){
  // 判断曝光地址是pm，还是cm？ 
  // 是pm中间点曝光，则在指定广告播放时间点，向监测系统曝光和广告系统曝光； 
  // 是cm监测曝光，则视频广告播放完成后，再向监测系统和广告系统曝光。  
// pm是曝光检测url；  tm是中间点监测
  if('是否获取到物料、曝光地址？' = false){
    '进入launcher主页'
  }
}

function('请求广告视频（CDN）是否超时？ 2s'){
  if('请求广告视频（CDN）是否超时？ 2s'){
    '进入launcher主页'
  }else{
    function('绘制控件，  播放广告')//即function(倒计时任务)，
    function('向监测系统和广告系统做监测曝光')
  }
}
/*  */
// '向监测系统和广告系统做监测曝光'
/* 第一大函数 */
function(倒计时任务){
  '倒计时（任务）'
  '更新右上角显示的倒计时时间'
  function ('倒计时是否结束？')
}
/*  */
function('倒计时是否结束？'){
  if('倒计时是否结束？'){
    // 携带区域码和SN号调用广告API接口获取开机广告视频
    function('广告播放倒计时是否结束')
  }else{
    function ('倒计时任务')
  }
}
function('广告播放倒计时是否结束'){
  if('广告播放倒计时是否结束' = false){
    '退出广告播放 窗口'
  }
  function('回收播放器资源')
}
  
function('回收播放器资源'){
  if('可按键退出的任务是否结束？'){
    function('中间点曝光的任务是否结束')
  }else{
    '移除可按键退出的任务'
    '进入launcher主页'
  }
}
function ('可按键退出的任务是否结束？'){
  if('可按键退出的任务是否结束？' = false){
    '移除可按键退出的任务'
  }
  function ('中间点曝光的任务是否结束')
}
function ('中间点曝光的任务是否结束'){
  if('中间点曝光的任务是否结束？' = false){
    '移除可按键退出的任务'
  }
  '进入launcher主页'
}

/* 第二大函数 */
function('广告开始播放'){
  if('广告视频播放完成'){
    '停止广告播放显示最后一帧'
  }

}
/* 第三大函数 */
function('是否存在中间点曝光？'){
  if('是否存在中间点曝光？'){
    '等待中间点曝光时间到达'
    '中间点曝光时间到达'
    function('向监测系统和广告系统做监测曝光')
  }
}
function('向监测系统和广告系统做监测曝光'){
//   携带usercode 和area_id请求广告系统，广告系统返回广告地址和曝光地址。
// 监控曝光地址包括： pm （监测曝光） 和 tm（中间点曝光）。
//   2、视频广告开始播放后，终端判断曝光地址是否是中间点曝光。 
// 如果不是中间点曝光，立即向监测系统和广告系统曝光。
// 如果是中间点曝光，在播放到固定的时间点进行曝光。
  // 3、曝光url地址和参数通过HTTP GET 方式请求曝光网址即可。
}
/* 第四大函数 */
function('等待可按键退出时间到达（任务）'){
  '可按键退出时间到达'
  '允许按键退出，右上角显示“按返回键退出”'
  '监听用户“按键退出'

}

```

